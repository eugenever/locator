# Locator

Разработка проводилась для использования в рамках кикшеринга `Whoosh`.

Приложение представляет собой аналог сервиса `Яндекс Локатор`. Имеет улучшенный алгоритм локализации по WiFi точкам доступа на основе взвешенного RSSI и сигналам базовых станций (LTE, WCDMA, GSM). Позволяет накапливать собственную базу данных измерений для точек доступа и проводить по ним локализацию.

Важным требованием проекта является поддержка высокого значения RPS (несколько десятков тысяч).

## Сбор измерений

Может осуществляться непосредственно с устройств или через приложение [NeoStumbler](https://github.com/mjaakko/NeoStumbler).


## Установка

### Файлы конфигурации

`config.toml` используется приложением `locator`.
`.env` устанавливает переменные окружения для подключения к `PostgreSQL`.

```sh
cp .env.example .env
cp config.example.toml config.toml
```

### Зависимости

- Rust build tool [Cargo](https://www.rust-lang.org/learn/get-started)
- `sqlx-cli` для создания базы данных и необходимых таблиц в `PostgreSQL`
- PostgreSQL
- кастомный [Tile38](https://github.com/eugenever/tile38)

### Базы данных

`locator` использует внешнюю базу данных `PostgreSQL` (с партиционированием по дням) и хранилище геоданных `Tile38` в оперативной памяти.
`Tile38` может включать один мастер или один мастер и одну реплику.
В случае аварийного отключения мастера происходит автоматическое переключение на реплику, которая затем становится мастером. После восстановления предыдущего мастера он автоматически переключается в режим реплики (подписывается на новый мастер).


### Сборка

Для сборки приложения локатор выполнить команды:

```sh
# Debug build
cargo build

# Release build
cargo build --release
```

Для сборки всех бинарных сервисов `Tile38` из корня его репозитория выполнить команду:

```sh
make all
```


### Запуск

Установить [sqlx-cli](https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md):

```sh
cargo install sqlx-cli
```

Выполнить настройку базы данных `PostgreSQL`:

```sh
source .env

# Create database and schema
cargo sqlx database create
cargo sqlx migrate run
```

Запустить приложение локатора:

```sh
locator serve
```

Сервер будет доступен по адресу `http://127.0.0.0.1:8080`.